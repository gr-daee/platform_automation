---
description: Context-Aware Test Generation - Enforce reading knowledge base and source code before creating tests
globs: e2e/**/*.ts, e2e/**/*.feature, docs/**/*.md
alwaysApply: true
---

# Context-Aware Test Generation

**CRITICAL RULE**: Before generating ANY test code, you MUST read and understand the existing knowledge base and source code.

## Mandatory Pre-Reading Checklist

When asked to create tests, generate Page Objects, or write step definitions, you MUST complete this checklist:

### 1. Module Knowledge (REQUIRED)
- [ ] Read `docs/modules/[module-name]/knowledge.md` - Application knowledge for the module
- [ ] Read `docs/modules/[module-name]/test-cases.md` - Existing test cases (avoid duplicates)
- [ ] Read `docs/modules/[module-name]/gap-analysis.md` - Known gaps and issues
- [ ] Read `docs/modules/[module-name]/discussions.md` - Module discussions and decisions
- [ ] Read `docs/modules/[module-name]/README.md` - Module overview

### 2. Source Code Analysis (REQUIRED)
- [ ] Read `../web_app/src/app/[module]/page.tsx` - Main page component
- [ ] Read all components in `../web_app/src/app/[module]/components/*.tsx`
- [ ] Read related API routes: `../web_app/src/app/api/[module]/**/*.ts`
- [ ] Understand component structure, props, and state management
- [ ] Identify all interactive elements (inputs, buttons, dropdowns, dialogs)

### 3. Existing Test Patterns (REQUIRED)
- [ ] Check `e2e/features/[module]/` for existing feature files
- [ ] Review `e2e/src/pages/[module]/` for existing Page Objects
- [ ] Review `e2e/src/steps/` for existing step definitions
- [ ] Understand established patterns and conventions
- [ ] Follow the same structure and naming conventions

### 4. Knowledge Base (REQUIRED for complex modules)
- [ ] Read `docs/knowledge-base/database-schema.md` - Database structure
- [ ] Read `docs/knowledge-base/business-rules.md` - Business logic
- [ ] Read `docs/knowledge-base/architecture.md` - System architecture
- [ ] Read `docs/knowledge-base/api-endpoints.md` - API documentation

### 5. Framework Patterns (REQUIRED)
- [ ] Review `docs/framework/implementation/IMPLEMENTATION_COMPLETE.md`
- [ ] Review `.cursor/rules/sqa-standards.mdc` - Automation standards
- [ ] Review `.cursor/rules/sqa-generator.mdc` - Generation patterns
- [ ] Understand Sandwich Method for DB verification
- [ ] Follow semantic locator strategy

## Workflow Example

**User Request**: "Create test for O2C Indent creation"

**You MUST**:
1. Read `docs/modules/o2c/knowledge.md`
2. Read `docs/modules/o2c/test-cases.md`
3. Read `docs/modules/o2c/gap-analysis.md`
4. Read `../web_app/src/app/o2c/indents/page.tsx`
5. Read `../web_app/src/app/o2c/indents/components/*.tsx`
6. Check `e2e/features/o2c/` for existing tests
7. Review `e2e/src/pages/o2c/` for existing POMs
8. Read `docs/knowledge-base/database-schema.md` for indent table structure
9. Read `docs/knowledge-base/business-rules.md` for indent creation rules
10. **THEN** generate test following established patterns

## Reading Order Priority

1. **Module Knowledge** (highest priority - understand the domain)
2. **Existing Tests** (avoid duplicates, follow patterns)
3. **Source Code** (understand what to test)
4. **Knowledge Base** (understand data model and business rules)
5. **Framework Patterns** (follow established conventions)

## What to Extract from Reading

### From Module Knowledge:
- Business rules and constraints
- Key workflows and user journeys
- Edge cases and error scenarios
- Dependencies on other modules

### From Source Code:
- Component structure and hierarchy
- Form fields and their validation
- Button actions and navigation
- State management patterns
- API calls and data flow

### From Existing Tests:
- Test structure and organization
- Page Object patterns
- Step definition patterns
- Assertion strategies
- Data setup/teardown patterns

### From Knowledge Base:
- Database schema and relationships
- API endpoint contracts
- Business rule implementations
- Cross-module dependencies

## Prohibited Actions

❌ **DO NOT** generate tests without reading module knowledge
❌ **DO NOT** create duplicate test cases
❌ **DO NOT** ignore existing patterns
❌ **DO NOT** skip source code analysis
❌ **DO NOT** assume business rules - read them first

## When Knowledge is Missing

If required documentation doesn't exist:
1. **Inform the user** that knowledge base needs to be populated
2. **Create the knowledge file** as part of your work
3. **Extract knowledge** from source code analysis
4. **Document your findings** in the appropriate knowledge file

## Integration with Other Rules

This rule works in conjunction with:
- `sqa-generator.mdc` - Uses context to generate better code
- `sqa-standards.mdc` - Applies standards based on context
- `docs-management.mdc` - Updates docs after reading context

## Success Indicators

✅ You've read all relevant docs before generating code
✅ Generated tests follow existing patterns
✅ No duplicate test cases created
✅ Tests reflect actual business rules
✅ Page Objects match actual component structure
✅ Documentation is updated with new knowledge

## Example: Complete Context Reading

```typescript
// Before generating O2C Indent test:

// 1. Read module knowledge
// docs/modules/o2c/knowledge.md:
//   - Indents are purchase requisitions
//   - Must have dealer, products, quantities
//   - Status flow: draft -> submitted -> approved

// 2. Read existing tests
// e2e/features/o2c/indents.feature:
//   - Already has "Create draft indent" scenario
//   - Missing "Submit indent" scenario

// 3. Read source code
// ../web_app/src/app/o2c/indents/page.tsx:
//   - Uses IndentForm component
//   - Has dealer selector (Radix Select)
//   - Has product table with quantity inputs
//   - Submit button triggers API call

// 4. Read knowledge base
// docs/knowledge-base/database-schema.md:
//   - indents table: id, dealer_id, status, created_at
//   - indent_items table: indent_id, product_id, quantity

// 5. Generate test following patterns
// - Use existing IndentPage POM
// - Follow Sandwich Method for DB verification
// - Use semantic locators (getByRole, getByPlaceholder)
```

## Remember

**Context is King**: The more context you have, the better your generated code will be. Always read first, generate second.
