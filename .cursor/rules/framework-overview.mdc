---
description: Overview of DAEE Test Automation Framework Architecture
globs: e2e/**/*.ts, e2e/**/*.feature, playwright.config.ts
alwaysApply: false
---

# DAEE Test Automation Framework

## Framework Stack

- **Test Framework**: Playwright (Browser automation)
- **BDD Layer**: playwright-bdd (Cucumber integration)
- **Reporting**: monocart-reporter (Rich HTML reports)
- **Language**: TypeScript
- **Database**: PostgreSQL (pg client for Supabase)
- **MFA**: otpauth (TOTP generation)

## Architecture Layers

```
┌─────────────────────────────────────────┐
│         Feature Files (.feature)        │
│     Business-readable Gherkin syntax    │
└──────────────────┬──────────────────────┘
                   │
┌──────────────────▼──────────────────────┐
│       Step Definitions (*-steps.ts)     │
│    Maps Gherkin to Page Object calls    │
│    Implements Sandwich Method (DB)      │
└──────────────────┬──────────────────────┘
                   │
┌──────────────────▼──────────────────────┐
│      Page Objects (*Page.ts)            │
│   Semantic locators + UI interactions   │
└──────────────────┬──────────────────────┘
                   │
┌──────────────────▼──────────────────────┐
│     Support Layer (db-helper, etc)      │
│   Database queries, fixtures, utils     │
└─────────────────────────────────────────┘
```

## Key Patterns

### 1. Sandwich Method (DB Verification)
```typescript
// Step definition example
When('I perform action', async () => {
  // 1. DB BEFORE - Query initial state
  const before = await getUserByEmail(email);
  
  // 2. UI ACTION - Perform user interaction
  await loginPage.performLogin(email, password, totp);
  
  // 3. DB AFTER - Verify state change
  const after = await getUserByEmail(email);
  expect(after.last_sign_in_at).not.toBe(before.last_sign_in_at);
});
```

### 2. Page Object Pattern
```typescript
export class LoginPage {
  readonly page: Page;
  readonly emailInput: Locator;
  
  constructor(page: Page) {
    this.page = page;
    // Use semantic locators
    this.emailInput = page.getByPlaceholder('Enter your email');
  }
  
  async performLogin(email, password, totpSecret) {
    await this.fillEmail(email);
    await this.fillPassword(password);
    await this.clickSignIn();
    await this.completeTOTPVerification(totpSecret, email);
  }
}
```

### 3. Pre-Authentication (Global Setup)
```typescript
// global.setup.ts
// Runs once before all tests
// Saves authenticated state to .auth/admin.json
// Tests reuse this state (faster execution)
```

### 4. Environment Variables Pattern
```env
TEST_USER_[ROLE]_EMAIL
TEST_USER_[ROLE]_PASSWORD
TEST_USER_[ROLE]_TOTP_SECRET
```

## File Organization

```
e2e/
├── features/           # Gherkin feature files
│   └── [module]/
│       └── *.feature
├── src/
│   ├── pages/         # Page Object Models
│   │   └── [module]/
│   │       └── *Page.ts
│   ├── steps/         # Step definitions
│   │   └── *-steps.ts
│   └── support/       # Utilities
│       ├── db-helper.ts
│       ├── fixtures.ts
│       └── global.setup.ts
└── fixtures/          # Test data files
```

## Locator Strategy (Priority Order)

1. `data-testid` (if available)
2. `getByRole('button', { name: '...' })`
3. `getByPlaceholder('...')`
4. `getByText('...')`
5. `locator('input#id')`
6. ❌ **FORBIDDEN**: CSS class selectors (e.g., `.bg-red-500`)

## Database Access (Read-Only)

All database queries must be SELECT-only:
```typescript
// ✅ ALLOWED
await executeQuery('SELECT * FROM auth.users WHERE email = $1', [email]);

// ❌ FORBIDDEN (Read-Only mode)
await executeQuery('DELETE FROM auth.users WHERE id = $1', [id]);
```

## Test Data Naming

When creating transactional data via UI:
```typescript
// Prefix with AUTO_QA_ and timestamp
const entityName = `AUTO_QA_${Date.now()}_IndentForm`;
```

## ShadCN/Radix UI Interactions

```typescript
// ❌ BAD: Won't work on Radix Select
await page.selectOption('select', 'value');

// ✅ GOOD: Click trigger, then option
await page.click('[role="combobox"]');
await page.getByRole('option', { name: 'Target Value' }).click();
```

## Running Tests

```bash
# Generate BDD files
npm run bdd:generate

# Run all tests
npm test

# Run specific feature
npm test login

# Headed mode (see browser)
npm run test:headed

# UI mode (interactive)
npm run test:ui

# View report
npm run test:report
```

## Configuration

- **playwright.config.ts**: Main configuration
- **.env.local**: Environment-specific settings (git-ignored)
- **tsconfig.json**: TypeScript compiler settings

## Global Setup Flow

```
1. Read admin credentials from .env.local
2. Launch browser
3. Navigate to /login
4. Fill email + password
5. Generate TOTP code (otpauth)
6. Complete TOTP verification
7. Wait for redirect to /notes
8. Save storage state to .auth/admin.json
9. Close browser
```

## When to Use This Framework

- ✅ End-to-end user flows
- ✅ Critical path testing
- ✅ Cross-browser compatibility
- ✅ Authentication flows with MFA
- ✅ Database state verification
- ✅ Regression testing

## When NOT to Use

- ❌ Unit tests (use Jest/Vitest)
- ❌ API-only tests (use Supertest/Axios)
- ❌ Load testing (use k6/JMeter)
- ❌ Static code analysis (use ESLint/TypeScript)

## Debugging

```bash
# Run with Playwright Inspector
npm run test:debug

# Run in headed mode
HEADED=true npm test

# View screenshots on failure
# Located in: test-results/*/screenshots/

# View trace on failure
# Located in: test-results/*/trace.zip
# Open with: npx playwright show-trace trace.zip
```

## CI/CD Integration

The framework is CI-ready:
- Headless execution
- Screenshot/video on failure
- HTML reports
- Configurable retries
- Environment variable based configuration

## Standards Compliance

This framework follows:
- `.cursor/rules/sqa-standards.mdc` - Automation standards
- `.cursor/rules/sqa-generator.mdc` - POM generation guidelines

## Support

For questions or issues:
- Check README.md
- Check SETUP_GUIDE.md
- Check IMPLEMENTATION_COMPLETE.md
- Contact DAEE QA team
